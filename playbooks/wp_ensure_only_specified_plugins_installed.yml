- name: "Get list of plugins installed on {{ site.id }}"
  ansible.builtin.command: >
    docker run --rm --volumes-from "{{ site.id }}"-wp-1 
    --network container:"{{ site.id }}"-wp-1 --user 33:33
    -e WORDPRESS_DB_HOST=db
    -e WORDPRESS_DB_USER="{{ site.wp_settings.db_user | default(default_db_user) }}"
    -e WORDPRESS_DB_PASSWORD="{{ site.wp_settings.db_user_password | default(default_db_user_password) }}"
    -e WORDPRESS_DB_NAME="{{ site.wp_settings.db_name | default(default_db_name) }}"
    "{{ site.wp_settings.wp_cli_image | default(default_wp_cli_image) }}"
    wp plugin list --format=json --fields=name
  register: plugin_list_result
  failed_when: false
  changed_when: false

- name: "Parse plugin list"
  ansible.builtin.set_fact:
    plugin_list: "{{ plugin_list_result.stdout | from_json }}"

- name: "Create list of plugin names"
  ansible.builtin.set_fact:
    plugin_name_list: "{{ plugin_list | map(attribute='name') }}"

#- ansible.builtin.debug:
#    msg: "plugin_name_list: {{ plugin_name_list }}"

- name: "Install specified plugins not installed on {{ site.id }}"
  ansible.builtin.command: >
    docker run --rm --volumes-from "{{ site.id }}"-wp-1 
    --network container:"{{ site.id }}"-wp-1 --user 33:33
    -e WORDPRESS_DB_HOST=db
    -e WORDPRESS_DB_USER="{{ site.wp_settings.db_user | default(default_db_user) }}"
    -e WORDPRESS_DB_PASSWORD="{{ site.wp_settings.db_user_password | default(default_db_user_password) }}"
    -e WORDPRESS_DB_NAME="{{ site.wp_settings.db_name | default(default_db_name) }}"
    "{{ site.wp_settings.wp_cli_image | default(default_wp_cli_image) }}"
    wp plugin install {{ plugin_name }}
  loop: "{{ site.wp_settings.plugins }}"
  loop_control:
    loop_var: plugin_name
  when: not plugin_name in plugin_name_list

- name: "Remove unspecified plugins on {{ site.id }}"
  ansible.builtin.command: >
    docker run --rm --volumes-from "{{ site.id }}"-wp-1 
    --network container:"{{ site.id }}"-wp-1 --user 33:33
    -e WORDPRESS_DB_HOST=db
    -e WORDPRESS_DB_USER="{{ site.wp_settings.db_user | default(default_db_user) }}"
    -e WORDPRESS_DB_PASSWORD="{{ site.wp_settings.db_user_password | default(default_db_user_password) }}"
    -e WORDPRESS_DB_NAME="{{ site.wp_settings.db_name | default(default_db_name) }}"
    "{{ site.wp_settings.wp_cli_image | default(default_wp_cli_image) }}"
    wp plugin delete {{ plugin_name }}
  loop: "{{ plugin_name_list }}"
  loop_control:
    loop_var: plugin_name
  when: not plugin_name in site.wp_settings.plugins
